# راهنمای توسعه بک‌اند سامانه انتخابات الکترونیک

این راهنما برای توسعه‌دهندگان بک‌اند سامانه انتخابات الکترونیک اتحادیه‌های صنفی تهیه شده است. در این راهنما، ساختار بانک اطلاعاتی، API‌ها و نحوه پیاده‌سازی آن‌ها توضیح داده شده است.

## فهرست مطالب

1. [معماری سیستم](#معماری-سیستم)
2. [ساختار بانک اطلاعاتی](#ساختار-بانک-اطلاعاتی)
3. [API‌ها](#apiها)
4. [احراز هویت](#احراز-هویت)
5. [امنیت](#امنیت)
6. [توابع سمت سرور](#توابع-سمت-سرور)
7. [نکات پیاده‌سازی](#نکات-پیاده‌سازی)

## معماری سیستم

سامانه انتخابات الکترونیک از معماری سه لایه استفاده می‌کند:

1. **لایه ارائه (Frontend)**: پیاده‌سازی شده با React و TypeScript
2. **لایه منطق کسب و کار (Backend)**: پیاده‌سازی شده با Supabase Functions و PostgreSQL
3. **لایه داده (Database)**: پیاده‌سازی شده با PostgreSQL در Supabase

ارتباط بین لایه‌ها از طریق API‌های RESTful و توابع سمت سرور (RPC) انجام می‌شود.

## ساختار بانک اطلاعاتی

بانک اطلاعاتی سامانه شامل جداول زیر است:

### جداول اصلی

1. **users**: اطلاعات کاربران
2. **candidates**: اطلاعات کاندیداها
3. **votes**: آرای ثبت شده
4. **verification_codes**: کدهای تأیید ارسال شده
5. **chat_rooms**: اتاق‌های چت
6. **chat_messages**: پیام‌های چت
7. **chat_participants**: شرکت‌کنندگان در چت
8. **candidate_media**: رسانه‌های کاندیداها
9. **surveys**: نظرسنجی‌ها
10. **expectations**: انتظارات اعضا
11. **webinars**: وبینارها
12. **webinar_participants**: شرکت‌کنندگان وبینارها
13. **business_categories**: رسته‌های صنفی

### روابط بین جداول

- هر کاربر می‌تواند یک کاندیدا باشد (رابطه یک به یک)
- هر کاربر می‌تواند یک رأی داشته باشد (رابطه یک به یک)
- هر کاندیدا می‌تواند چندین رسانه داشته باشد (رابطه یک به چند)
- هر کاندیدا می‌تواند چندین وبینار داشته باشد (رابطه یک به چند)
- هر کاربر می‌تواند در چندین اتاق چت شرکت کند (رابطه چند به چند)
- هر کاربر می‌تواند در چندین وبینار شرکت کند (رابطه چند به چند)

## API‌ها

API‌های سامانه در فایل `src/lib/api.ts` پیاده‌سازی شده‌اند. این API‌ها به صورت ماژول‌های مختلف دسته‌بندی شده‌اند:

### usersApi

API‌های مربوط به کاربران:

- `getUsers`: دریافت لیست کاربران
- `getUser`: دریافت اطلاعات یک کاربر
- `updateUser`: بروزرسانی اطلاعات کاربر
- `approveUser`: تأیید کاربر
- `registerUser`: ثبت‌نام کاربر جدید

### candidatesApi

API‌های مربوط به کاندیداها:

- `getCandidates`: دریافت لیست کاندیداها
- `getCandidate`: دریافت اطلاعات یک کاندیدا
- `registerCandidate`: ثبت کاندیدا
- `approveCandidate`: تأیید کاندیدا
- `getCandidateMedia`: دریافت رسانه‌های کاندیدا
- `addCandidateMedia`: افزودن رسانه برای کاندیدا

### votesApi

API‌های مربوط به رأی‌گیری:

- `castVote`: ثبت رأی
- `getResults`: دریافت نتایج رأی‌گیری
- `getUserVote`: بررسی رأی کاربر

### surveysApi

API‌های مربوط به نظرسنجی‌ها:

- `getSurveys`: دریافت لیست نظرسنجی‌ها
- `createSurvey`: ایجاد نظرسنجی جدید
- `voteInSurvey`: ثبت رأی در نظرسنجی

### expectationsApi

API‌های مربوط به انتظارات:

- `getExpectations`: دریافت لیست انتظارات
- `createExpectation`: ایجاد انتظار جدید
- `addCandidateResponse`: افزودن پاسخ کاندیدا به انتظار

### chatApi

API‌های مربوط به چت و پیام‌رسانی:

- `getChatRooms`: دریافت لیست اتاق‌های چت
- `createChatRoom`: ایجاد اتاق چت جدید
- `getChatMessages`: دریافت پیام‌های یک اتاق چت
- `sendMessage`: ارسال پیام در اتاق چت
- `joinChatRoom`: پیوستن به اتاق چت
- `deleteMessage`: حذف پیام

### webinarsApi

API‌های مربوط به وبینارها:

- `getWebinars`: دریافت لیست وبینارها
- `createWebinar`: ایجاد وبینار جدید
- `registerForWebinar`: ثبت‌نام در وبینار

## احراز هویت

سیستم احراز هویت سامانه در فایل `src/lib/auth.ts` پیاده‌سازی شده است. این سیستم از احراز هویت مبتنی بر OTP (رمز یکبار مصرف) استفاده می‌کند:

1. کاربر شماره موبایل خود را وارد می‌کند
2. سیستم یک کد تأیید به شماره موبایل کاربر ارسال می‌کند
3. کاربر کد دریافتی را وارد می‌کند
4. سیستم کد را بررسی می‌کند و در صورت صحت، کاربر را وارد سیستم می‌کند

توابع اصلی احراز هویت:

- `sendOTP`: ارسال کد تأیید
- `verifyOTP`: تأیید کد وارد شده
- `loginUser`: ورود کاربر به سیستم
- `checkExistingSession`: بررسی وجود نشست فعال
- `logoutUser`: خروج کاربر از سیستم

## امنیت

سامانه از چندین لایه امنیتی استفاده می‌کند:

1. **Row Level Security (RLS)**: کنترل دسترسی در سطح ردیف‌های جداول
2. **توابع SECURITY DEFINER**: اجرای توابع با سطح دسترسی بالاتر
3. **احراز هویت دو مرحله‌ای**: استفاده از OTP برای تأیید هویت
4. **توکن‌های JWT**: استفاده از توکن‌های JWT برای احراز هویت API
5. **سیاست‌های دسترسی**: تعریف سیاست‌های دسترسی برای هر جدول

## توابع سمت سرور

توابع سمت سرور (RPC) در فایل‌های مهاجرت Supabase پیاده‌سازی شده‌اند. این توابع امکان اجرای منطق پیچیده در سمت سرور را فراهم می‌کنند:

### توابع احراز هویت

- `create_verification_code`: ایجاد کد تأیید
- `verify_code`: تأیید کد
- `register_user`: ثبت‌نام کاربر

### توابع کاندیداها

- `register_candidate`: ثبت کاندیدا
- `approve_candidate`: تأیید کاندیدا

### توابع رأی‌گیری

- `cast_vote`: ثبت رأی
- `get_vote_results`: دریافت نتایج رأی‌گیری
- `has_user_voted`: بررسی وجود رأی کاربر

### توابع چت

- `create_chat_room`: ایجاد اتاق چت
- `send_message`: ارسال پیام

### توابع نظرسنجی

- `vote_in_survey`: ثبت رأی در نظرسنجی

### توابع انتظارات

- `add_candidate_response`: افزودن پاسخ کاندیدا به انتظار
- `add_expectation_comment`: افزودن نظر به انتظار
- `react_to_expectation`: واکنش به انتظار

### توابع رسانه

- `add_media_comment`: افزودن نظر به رسانه کاندیدا
- `react_to_media`: واکنش به رسانه

## نکات پیاده‌سازی

### 1. مدیریت خطاها

در پیاده‌سازی API‌ها، از الگوی try-catch برای مدیریت خطاها استفاده شده است. در صورت بروز خطا، پیام مناسب به کاربر نمایش داده می‌شود.

### 2. محیط توسعه و تولید

سامانه از متغیر `import.meta.env.PROD` برای تشخیص محیط اجرا استفاده می‌کند:

```typescript
if (import.meta.env.PROD) {
  // کد مربوط به محیط تولید
} else {
  // کد مربوط به محیط توسعه
}
```

### 3. لاگ کردن

برای لاگ کردن خطاها و اطلاعات مفید، از `console.error` و `console.log` استفاده شده است. در محیط تولید، می‌توان از سرویس‌های لاگ پیشرفته‌تر استفاده کرد.

### 4. کش کردن

برای بهبود کارایی، می‌توان از کش کردن داده‌ها در سمت کلاینت استفاده کرد. این کار می‌تواند با استفاده از `localStorage` یا کتابخانه‌های کش مانند `react-query` انجام شود.

### 5. پیاده‌سازی Realtime

برای پیاده‌سازی قابلیت‌های realtime مانند چت، می‌توان از قابلیت‌های realtime Supabase استفاده کرد:

```typescript
const subscription = supabase
  .from('chat_messages')
  .on('INSERT', (payload) => {
    // پردازش پیام جدید
  })
  .subscribe();
```

### 6. مدیریت وضعیت

برای مدیریت وضعیت سمت کلاینت، از کتابخانه Zustand استفاده شده است. استورهای اصلی عبارتند از:

- `useAuthStore`: مدیریت وضعیت احراز هویت
- `useVoteStore`: مدیریت وضعیت رأی‌گیری
- `useThemeStore`: مدیریت وضعیت تم

## نتیجه‌گیری

این راهنما، مروری کلی بر ساختار بک‌اند سامانه انتخابات الکترونیک ارائه می‌دهد. برای اطلاعات بیشتر، به کد منبع و مستندات API مراجعه کنید.